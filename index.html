<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Shake Again Media Plan Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      background: #232323;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 800px;
      margin: 0 auto;
      background: #313131;
      border-radius: 12px;
      box-shadow: 0 0 18px rgba(0,0,0,0.13);
      border: 1.5px solid #eee;
      position: relative;
    }
    #header {
      display: flex;
      align-items: center;
      justify-content: start;
      background: #ffff;
      border-radius: 12px 12px 0 0;
      padding: 16px 28px;
      border-bottom: 1px solid #3a3a3a;
    }
    #header img {
      height: 44px;
      margin-right: 16px;
    }
    #header span {
      color: #fff;
      font-size: 1.35rem;
      font-weight: bold;
      letter-spacing: 1px;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 26px 24px 16px 24px;
      background: #313131;
      min-height: 0;
      border-radius: 0 0 0 0;
      font-size: 1.07rem;
      box-sizing: border-box;
    }
    .message {
      margin-bottom: 14px;
      line-height: 1.6;
      word-break: break-word;
      max-width: 100%;
    }
    .bot-message {
      background: #28282e;
      color: #fff;
      border-left: 4px solid #e54e47;
      padding: 13px 17px;
      border-radius: 7px;
      margin-right: 80px;
      margin-left: 0;
      margin-bottom: 14px;
      font-size: 1.04rem;
    }
    .user-message {
      background: #e54e47;
      color: #fff;
      align-self: flex-end;
      padding: 13px 17px;
      border-radius: 7px;
      margin-left: 80px;
      margin-right: 0;
      margin-bottom: 14px;
      text-align: right;
      font-weight: 500;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 14px 0;
      font-size: 0.97rem;
    }
    th, td {
      border: 1px solid #575757;
      padding: 6px 10px;
      color: #fff;
      text-align: left;
    }
    th {
      background: #393939;
      color: #f0f0f0;
      font-weight: 700;
    }
    #input-area {
      display: flex;
      background: #232323;
      border-radius: 0 0 12px 12px;
      padding: 18px 24px;
      border-top: 1px solid #3a3a3a;
      align-items: center;
    }
    #chat-input {
      flex: 1;
      padding: 13px 16px;
      border-radius: 6px;
      border: 1.5px solid #a1a1a1;
      font-size: 1rem;
      outline: none;
      background: #fafafa;
      margin-right: 14px;
    }
    #send-btn {
      padding: 11px 22px;
      background: #e54e47;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    #send-btn:hover { background: #c13b34; }
    /* Responsive */
    @media (max-width: 900px) {
      #chat-container {
        max-width: 100vw;
        border-radius: 0;
      }
    }
    @media (max-width: 650px) {
      #chat-container {
        max-width: 100vw;
        border-radius: 0;
      }
      #header { padding: 11px 12px; }
      #messages, #input-area { padding: 11px 8px; }
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="header">
      <img src="https://shakeagain.com/wp-content/uploads/2023/01/SA-logo-color.png" alt="Shake Again Logo" />
      <span>Shake Again Media Plan Chat</span>
    </div>
    <div id="messages"></div>
    <form id="input-area">
      <input id="chat-input" autocomplete="off" placeholder="Escribe tu mensaje..." />
      <button id="send-btn" type="submit">Enviar</button>
    </form>
  </div>

  <script>
    // PON AQU√ç LA URL DE TU WEBHOOK DE N8N
    const webhookUrl = "https://primary-production-639b.up.railway.app/webhook/07d5295f-2b0c-4efb-bcf1-18755bd8739a/chat"; // <-- CAMBIA ESTO

    const messagesDiv = document.getElementById("messages");
    const inputArea = document.getElementById("input-area");
    const input = document.getElementById("chat-input");
    const sessionId = (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2, 12);

    // Mensajes iniciales (incluyendo "paciencia")
    function addWelcomeMessages() {
      addBotMessage("üëã ¬°Bienvenido! Soy tu asistente para la generaci√≥n de Media Plans. <br><b>¬øSobre qu√© cliente quieres que empecemos?</b>");
      addBotMessage("‚è≥ <b>Importante:</b> La primera operaci√≥n puede tardar 1-2 minutos. El resto ser√°n mucho m√°s r√°pidas. ¬°Gracias por tu paciencia! üòä");
    }

    // Renderiza mensajes del bot con markdown
    function addBotMessage(markdown) {
      const html = marked.parse(markdown);
      const div = document.createElement('div');
      div.className = 'message bot-message';
      div.innerHTML = html;
      messagesDiv.appendChild(div);
      scrollMessages();
    }

    // Renderiza mensajes del usuario
    function addUserMessage(text) {
      const div = document.createElement('div');
      div.className = 'message user-message';
      div.textContent = text;
      messagesDiv.appendChild(div);
      scrollMessages();
    }

    // Scroll to bottom
    function scrollMessages() {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Cuando llega la respuesta de n8n
    function addBotMessageFromOutput(n8nData) {
      if (n8nData.output) {
        // Si la respuesta es markdown, render√≠zala. Si es texto plano, tambi√©n.
        addBotMessage(n8nData.output);
      } else if (n8nData.error) {
        addBotMessage("‚ùå Hubo un error: " + n8nData.error);
      } else {
        addBotMessage("ü§ñ Recib√≠ una respuesta inesperada: <pre>" + JSON.stringify(n8nData, null, 2) + "</pre>");
      }
    }

    // Mensajes de carga
    function addLoadingMessage() {
      const div = document.createElement('div');
      div.className = 'message bot-message';
      div.innerHTML = "‚è≥ Procesando, por favor espera...";
      div.id = "loading-msg";
      messagesDiv.appendChild(div);
      scrollMessages();
      return div;
    }

    // Env√≠o del mensaje
    inputArea.addEventListener("submit", async function(e) {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      addUserMessage(text);
      input.value = "";
      const loadingDiv = addLoadingMessage();

      try {
        const res = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, sessionId })
        });

        // Intenta parsear como JSON
        const data = await res.json();
        messagesDiv.removeChild(loadingDiv);
        addBotMessageFromOutput(data);
      } catch (err) {
        messagesDiv.removeChild(loadingDiv);
        addBotMessage("‚ùóÔ∏èError al conectar con el servidor o tiempo de espera superado.");
      }
    });

    // Mensaje de bienvenida al cargar
    window.onload = addWelcomeMessages;
  </script>
</body>
</html>
